name: fcbtest
version: 0.2
summary: fcbtes–µ is Rally + Tempest + refstack tests
description: |
  Snap for running tests for Openstack platform using Rally framework, Tempest verifier and tests from refstack.
base: core18
grade: devel
# classic confinement is used as rally uses the 'multiprocessing' python module
# which uses  shared memory and accesses paths blocked via AppArmor policies of
# snapd which leads to segfaults when any of the rally tools are used
# see https://bugs.launchpad.net/snapcraft/+bug/1577514
# https://forum.snapcraft.io/t/python-multiprocessing-sem-open-blocked-in-strict-mode/962
confinement: classic

environment:
  PATH: $SNAP/bin:$SNAP/usr/bin:$PATH # :$SNAP/testrepository:
  PYTHONPATH: $SNAP/lib/python3.6/site-packages:$SNAP/bin/rally
  # see
  # https://github.com/GoogleCloudPlatform/google-auth-library-python/issues/249
  # https://github.com/ubuntu/ubuntu-make/issues/536#issuecomment-382112564
  # https://www.python.org/dev/peps/pep-0420/
  PYTHONHOME: $SNAP/usr
apps:
  fcbtest:
    command: echo "Usage - 0) SOURCE YOUR NOVARC 1)fcbtest.rallyinit 2) fcbtest.rally verify start 3) fcbtest.rallymanage for other settings"
    plugs: [home, network, network-bind]
  rally:
    command: rally
    plugs: [home, network, network-bind]
  rallymanage:
    command: rally-manage
    plugs: [home, network, network-bind]
  rallyinit:
    command: bin/rallyinit.sh
    plugs: [home, network, network-bind] 
  tempestinit:
    command: rally verify install --source /snap/fcbtest/current/tempest
    plugs: [home, network, network-bind]

parts:
  rally:
    plugin: python
    python-version: python3
    stage-packages:
      - python3-pip
      - build-essential
      - iputils-ping
      - libdb5.3
      - zlib1g
      - libcomerr2
      - libgcc1
      - libbz2-1.0
      - libc6
      - libblkid1
      - libcap2
      - libgcrypt20
      - libgpg-error0
      - liblzma5
      - libmount1
      - libncursesw5
      - libselinux1
      - libtinfo5
      - libuuid1
      - libstdc++6
      - libpcre3
    build-packages: [python3, python3-pip, build-essential, libffi-dev, libpq-dev, libssl-dev, libxml2-dev, libxslt1-dev, python3-dev, iputils-ping, zlib1g, libcomerr2, libgcc1]
    source: https://github.com/openstack/rally
    source-type: git
    source-tag: '1.4.1'
    constraints: upper-constraints.txt
    override-pull: |
      snapcraftctl pull
      sed -i -e '/python-dateutil==2.6.1/d' $SNAPCRAFT_PART_SRC/upper-constraints.txt

  rally-openstack:
    plugin: python
    python-version: python3
    build-packages: [python3, python3-pip, build-essential, libffi-dev, libpq-dev, libssl-dev, libxml2-dev, libxslt1-dev, python3-dev, iputils-ping, zlib1g, libcomerr2, libgcc1]
    source: https://github.com/openstack/rally-openstack
    source-type: git
    source-commit: 9993d0b684d60539e344aea94c1c8abfe0b2e74d
    constraints: upper-constraints.txt
    override-pull: |
      snapcraftctl pull
      sed -i -e '/argparse===1.2.1/d' $SNAPCRAFT_PART_SRC/upper-constraints.txt
      sed -i -e '/python-dateutil===2.7.3/d' $SNAPCRAFT_PART_SRC/upper-constraints.txt
    filesets:
      exclude-conflicting-files:
      - -lib/python3.6/site-packages/argparse.py
      - -lib/python3.6/site-packages/dateutil
      include-all:
      - ./*
    stage:
      - $exclude-conflicting-files
      - $include-all
  tempest:
    after: [rally]
    plugin: dump
    source: https://github.com/openstack/tempest
    source-type: git
    # take a specific tempest version
    source-tag: '19.0.0'
    # do nothing as we override the prime step
    # and do not need to stage or build anything
    override-stage: |
            :
    override-build: |
            :
    # rally expects tempest source with .git present
    # which means we have to clone the repo into the
    # target directory, including the hidden dir
    override-prime: |
            rm -fr $SNAPCRAFT_PRIME/tempest
            git clone $SNAPCRAFT_PART_SRC $SNAPCRAFT_PRIME/tempest
  copy-parts:
    after: [tempest]
    plugin: dump
    organize:
            rallyinit.sh: bin/rallyinit.sh
    stage:
            - bin/*
            - 2018.02-test-list.txt
